@model IEnumerable<HRMS.Models.AttendanceRecord>

@{
    ViewData["Title"] = "My Attendance Dashboard";

    var mostRecentRecord = Model.OrderByDescending(r => r.CheckInTime).FirstOrDefault();

    var isClockedIn = mostRecentRecord != null && mostRecentRecord.CheckOutTime == null;

    var currentTime = DateTime.Now.ToString("dd MMM yyyy HH:mm:ss");
}

<div class="row">
    <div class="col-12 text-center">
        <h1>Attendance Portal</h1>
        <p>Current Server Time: <strong>@currentTime</strong></p>
    </div>
</div>

<hr />

<div class="row mb-4">
    <div class="col-md-6 offset-md-3 text-center">

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
        }

        @if (isClockedIn)
        {
            <p class="lead text-success">
                **You are currently CLOCKED IN.**
                <br />
                Shift started at: @mostRecentRecord.CheckInTime.ToLocalTime().ToString("hh:mm tt")
            </p>
            <form asp-action="ClockOut" method="post">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger btn-lg">
                    <i class="bi bi-box-arrow-right"></i> Clock Out Now
                </button>
            </form>
        }
        else
        {
            <p class="lead text-secondary">
                **You are currently CLOCKED OUT.**
            </p>
            <form asp-action="ClockIn" method="post">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-box-arrow-in-left"></i> Clock In Now
                </button>
            </form>
        }
    </div>
</div>

<hr />
<h2>My Attendance History</h2>

<table class="table table-striped table-hover mt-3">
    <thead>
        <tr>
            <th>Date</th>
            <th>Check-In</th>
            <th>Check-Out</th>
            <th>Duration</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var record in Model)
        {
            <tr>
                <td>@record.Date.ToString("ddd, MMM dd")</td>
                <td>@record.CheckInTime.ToLocalTime().ToString("hh:mm:ss tt")</td>
                <td>
                    @if (record.CheckOutTime.HasValue)
                    {
                        @record.CheckOutTime.Value.ToLocalTime().ToString("hh:mm:ss tt")
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark">Active Shift</span>
                    }
                </td>
                <td>
                    @if (record.CheckOutTime.HasValue)
                    {
                        var duration = record.CheckOutTime.Value - record.CheckInTime;
                        @($"{duration.Hours}h {duration.Minutes}m {duration.Seconds}s")
                    }
                    else
                    {
                        <span>--</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>